id: render-rendercontext-integration
title: Integrate IFramebuffer into RenderContext
status: TODO
labels: [rendering, architecture, critical-path]
depends_on:
  - render-framebuffer-abstraction
goal: >
  Integrate IFramebuffer abstraction into RenderContext, making the framebuffer backends
  usable by the rendering engine. This is the critical path to enable backend selection.

steps:
  - Update RenderContext struct to include IFramebuffer* instead of raw pixel buffer.
  - Update Engine class to create and manage framebuffer instances.
  - Add framebuffer lifecycle management (creation, resize, destruction).
  - Update OffscreenRenderer to use IFramebuffer (currently uses raw buffer).
  - Ensure backward compatibility during transition (keep old buffer alongside new).
  - Migrate 2-3 simple effects as proof of concept (Clear, Blur, etc.).
  - Update frame() accessor to expose framebuffer data properly.
  - Add framebuffer initialization in Engine constructor.
  - Test that existing presets still render correctly with new RenderContext.
  - Document RenderContext changes for effect authors.

acceptance_criteria:
  - RenderContext has IFramebuffer* field accessible to all effects.
  - Engine can create CPU, OpenGL, or File framebuffer based on configuration.
  - Existing preset validation tests still pass (30/36 presets).
  - At least 2 effects successfully migrated to use new interface.
  - No performance regression in rendering (within 5% of baseline).
  - All existing tests continue to pass.

test_hook:
  - "ctest: preset_validation_tests ensures presets still render correctly."
  - "ctest: framebuffer_backend_tests validates backend functionality."
  - "Manual: Verify avs-player still displays presets correctly."

estimated_time: 2-3 hours

files_touched:
  - libs/avs-core/include/avs/core/RenderContext.hpp
  - libs/avs-compat/include/avs/compat/engine.hpp
  - libs/avs-compat/src/engine.cpp
  - libs/avs-testing/include/avs/testing/OffscreenRenderer.hpp
  - libs/avs-testing/src/OffscreenRenderer.cpp
  - libs/avs-effects-legacy/src/*/effect_*.cpp (2-3 effects for proof of concept)
  - docs/JOB_22A_RENDERCONTEXT_INTEGRATION.md

priority: HIGH
blockers: []
notes: >
  This is the critical path task. Once complete, backend selection becomes possible.
  We maintain backward compatibility by keeping the old pixel buffer view alongside
  the new IFramebuffer* during transition. Effects can be migrated incrementally.
