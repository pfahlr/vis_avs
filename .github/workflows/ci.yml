name: CI

on:
  push:
    branches:
      - development-branch
  pull_request:

env:
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: 750M

jobs:
  build:
    name: Build (${{ matrix.distro }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu
            container: ubuntu:22.04
            pkg_cache: /var/cache/apt
          - distro: fedora
            container: fedora:39
            pkg_cache: /var/cache/dnf
    container: ${{ matrix.container }}

    steps:
      - name: Detect available cores
        id: cores
        run: echo "cores=$(nproc)" >> "$GITHUB_OUTPUT"

      - name: Export parallel build level
        run: echo "CMAKE_BUILD_PARALLEL_LEVEL=${{ steps.cores.outputs.cores }}" >> "$GITHUB_ENV"

      - uses: actions/checkout@v4

      - name: Prepare cache directories
        run: |
          mkdir -p build/_deps
          mkdir -p .ccache
          mkdir -p "$HOME/.cache/fetchcontent"
          if [ "${{ matrix.distro }}" = "ubuntu" ]; then
            mkdir -p /var/cache/apt
          else
            mkdir -p /var/cache/dnf
          fi

      - name: Cache package manager artifacts
        uses: actions/cache@v4
        with:
          path: ${{ matrix.pkg_cache }}
          key: ${{ runner.os }}-${{ matrix.distro }}-pkg-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.distro }}-pkg-

      - name: Cache compiler cache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ runner.os }}-${{ matrix.distro }}-${{ hashFiles('**/CMakeLists.txt','cmake/**/*') }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.distro }}-

      - name: Cache FetchContent base dir
        uses: actions/cache@v4
        with:
          path: ${{ env.HOME }}/.cache/fetchcontent
          key: fetch-${{ runner.os }}-${{ hashFiles('**/CMakeLists.txt','cmake/**/*') }}
          restore-keys: |
            fetch-${{ runner.os }}-


      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ matrix.distro }}" = "ubuntu" ]; then
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y --no-install-recommends \
              build-essential \
              ccache \
              clang \
              cmake \
              git \
              ninja-build \
              pkg-config \
              python3 \
              libsdl2-dev \
              libgl1-mesa-dev \
              libglu1-mesa-dev \
              libasound2-dev \
              libjack-dev \
              libportaudio2 \
              portaudio19-dev \
              libsamplerate0-dev \
              libfftw3-dev
          else
            dnf -y makecache
            dnf -y install \
              ccache \
              clang \
              cmake \
              gcc \
              gcc-c++ \
              git \
              ninja-build \
              pkgconf-pkg-config \
              python3 \
              SDL2-devel \
              mesa-libGL-devel \
              mesa-libGLU-devel \
              alsa-lib-devel \
              jack-audio-connection-kit-devel \
              portaudio-devel \
              libsamplerate-devel \
              fftw-devel
          fi

      - name: Cache CMake dependencies
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: cmake-${{ matrix.distro }}-${{ hashFiles('CMakeLists.txt', 'libs/**/CMakeLists.txt', 'apps/**/CMakeLists.txt', 'tools/CMakeLists.txt', 'tests/CMakeLists.txt') }}
          restore-keys: |
            cmake-${{ matrix.distro }}-

      - name: Cache CMake configure metadata
        uses: actions/cache@v4
        with:
          path: |
            build/.ninja_deps
            build/.ninja_log
            build/CMakeCache.txt
            build/CMakeFiles
          key: graph-${{ runner.os }}-${{ matrix.distro }}-${{ hashFiles('**/CMakeLists.txt','cmake/**/*','src/**/*') }}
          restore-keys: |
            graph-${{ runner.os }}-${{ matrix.distro }}-

      # Optional: fix trust store if your runner image is missing CA certs
      - name: Ensure CA trust for git (defensive)
        run: |
          if [ "${{ matrix.distro }}" = "ubuntu" ]; then
            apt-get update
            apt-get install -y ca-certificates
            git config --global http.sslcainfo /etc/ssl/certs/ca-certificates.crt
            unset CURL_CA_BUNDLE SSL_CERT_FILE
          fi
      - name: Checkout PortAudio (shallow)
        uses: actions/checkout@v4
        with:
          repository: PortAudio/portaudio
          path: external/portaudio
          fetch-depth: 1

      # Prove the path exists before CMake runs (avoids the exact error you hit)
      - name: Verify PortAudio path
        shell: bash
        run: |
         set -euxo pipefail
         if [ "${{ matrix.distro }}" = "ubuntu" ]; then
           test -d "$GITHUB_WORKSPACE/external/portaudio/.git"
           ls -la "$GITHUB_WORKSPACE/external/portaudio" | head -n 20
         fi

      # Add after the PortAudio checkout
      - name: Checkout googletest (shallow)
        uses: actions/checkout@v4
        with:
          repository: google/googletest
          path: external/googletest
          fetch-depth: 1

      - name: Verify googletest path
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ matrix.distro }}" = "ubuntu" ]; then
          test -d "$GITHUB_WORKSPACE/external/googletest/.git"
          git -C "$GITHUB_WORKSPACE/external/googletest" rev-parse --short HEAD
          fi
      - name: Configure
        run: |
          if [ "${{ matrix.distro }}" = "ubuntu" ]; then
            cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DFETCHCONTENT_SOURCE_DIR_PORTAUDIO="$GITHUB_WORKSPACE/external/portaudio" \
            -DFETCHCONTENT_SOURCE_DIR_GOOGLETEST="$GITHUB_WORKSPACE/external/googletest" \
            -DFETCHCONTENT_FULLY_DISCONNECTED=ON \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_INSTALL_PREFIX="${PWD}/install"
          else
            cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_INSTALL_PREFIX="${PWD}/install"
          fi
      - name: Build
        run: cmake --build build -- -k 0

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.distro }}
          include-hidden-files: true
          path: |
            build
            !build/**/*.o
            !build/**/*.a

      - name: Install
        run: cmake --install build --prefix "${PWD}/install"

  tests:
    name: Tests (${{ matrix.distro }} shard ${{ matrix.shard }} of ${{ matrix.total_shards }})
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu
            container: ubuntu:22.04
            pkg_cache: /var/cache/apt
            shard: 0
            total_shards: 2
          - distro: ubuntu
            container: ubuntu:22.04
            pkg_cache: /var/cache/apt
            shard: 1
            total_shards: 2
          - distro: fedora
            container: fedora:39
            pkg_cache: /var/cache/dnf
            shard: 0
            total_shards: 2
          - distro: fedora
            container: fedora:39
            pkg_cache: /var/cache/dnf
            shard: 1
            total_shards: 2
    container: ${{ matrix.container }}

    steps:
      - name: Detect available cores
        id: cores
        run: echo "cores=$(nproc)" >> "$GITHUB_OUTPUT"

      - name: Export parallel build level
        run: echo "CMAKE_BUILD_PARALLEL_LEVEL=${{ steps.cores.outputs.cores }}" >> "$GITHUB_ENV"

      - uses: actions/checkout@v4

      - name: Prepare cache directories
        run: |
          mkdir -p .ccache
          mkdir -p "$HOME/.cache/fetchcontent"
          if [ "${{ matrix.distro }}" = "ubuntu" ]; then
            mkdir -p /var/cache/apt
          else
            mkdir -p /var/cache/dnf
          fi

      - name: Cache package manager artifacts
        uses: actions/cache@v4
        with:
          path: ${{ matrix.pkg_cache }}
          key: ${{ runner.os }}-${{ matrix.distro }}-pkg-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.distro }}-pkg-

      - name: Install runtime dependencies
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ matrix.distro }}" = "ubuntu" ]; then
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y --no-install-recommends \
              cmake \
              git \
              libasound2-dev \
              libgl1-mesa-dev \
              libglu1-mesa-dev \
              libjack-dev \
              libportaudio2 \
              libsdl2-dev \
              libsamplerate0-dev \
              libfftw3-dev \
              python3
          else
            dnf -y makecache
            dnf -y install \
              cmake \
              SDL2-devel \
              alsa-lib-devel \
              fftw-devel \
              git \
              jack-audio-connection-kit-devel \
              libsamplerate-devel \
              mesa-libGL-devel \
              mesa-libGLU-devel \
              portaudio-devel \
              python3
          fi

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.distro }}
          path: .

      - name: Run tests
        shell: bash
        env:
          SHARD_INDEX: ${{ matrix.shard }}
          SHARD_TOTAL: ${{ matrix.total_shards }}
        run: |
          set -euo pipefail
          if [ "${SHARD_TOTAL}" -le 1 ]; then
            ctest --test-dir build --output-on-failure --parallel "${CMAKE_BUILD_PARALLEL_LEVEL}"
            exit 0
          fi
          python3 .github/scripts/run_sharded_ctest.py
