name: CI

on:
  push:
    branches:
      - development-branch
  pull_request:

env:
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: 750M
  # Provide a safe default that keeps the workflow valid until the cores step
  # overrides it via $GITHUB_ENV.
  CMAKE_BUILD_PARALLEL_LEVEL: 1

jobs:
  build:
    name: Build (${{ matrix.distro }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu
            container: ubuntu:22.04
            pkg_cache: /var/cache/apt
          - distro: fedora
            container: fedora:39
            pkg_cache: /var/cache/dnf
    container: ${{ matrix.container }}

    steps:
      - name: Detect available cores
        id: cores
        run: echo "cores=$(nproc)" >> "$GITHUB_OUTPUT"

      - name: Export parallel build level
        run: echo "CMAKE_BUILD_PARALLEL_LEVEL=${{ steps.cores.outputs.cores }}" >> "$GITHUB_ENV"

      - uses: actions/checkout@v4

      - name: Prepare cache directories
        shell: bash
        env:
          DISTRO: ${{ matrix.distro }}
        run: .github/scripts/prepare_build_directories.sh

      - name: Cache package manager artifacts
        uses: actions/cache@v4
        with:
          path: ${{ matrix.pkg_cache }}
          key: ${{ runner.os }}-${{ matrix.distro }}-pkg-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.distro }}-pkg-

      - name: Cache compiler cache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ runner.os }}-${{ matrix.distro }}-${{ hashFiles('**/CMakeLists.txt','cmake/**/*') }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.distro }}-

      - name: Cache FetchContent base dir
        uses: actions/cache@v4
        with:
          path: ${{ env.HOME }}/.cache/fetchcontent
          key: fetch-${{ runner.os }}-${{ hashFiles('**/CMakeLists.txt','cmake/**/*') }}
          restore-keys: |
            fetch-${{ runner.os }}-


      - name: Install build dependencies
        shell: bash
        env:
          DISTRO: ${{ matrix.distro }}
        run: .github/scripts/install_build_dependencies.sh

      - name: Cache CMake dependencies
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: cmake-${{ matrix.distro }}-${{ hashFiles('CMakeLists.txt', 'libs/**/CMakeLists.txt', 'apps/**/CMakeLists.txt', 'tools/CMakeLists.txt', 'tests/CMakeLists.txt') }}
          restore-keys: |
            cmake-${{ matrix.distro }}-

      - name: Cache CMake configure metadata
        uses: actions/cache@v4
        with:
          path: |
            build/.ninja_deps
            build/.ninja_log
            build/CMakeCache.txt
            build/CMakeFiles
          key: graph-${{ runner.os }}-${{ matrix.distro }}-${{ hashFiles('**/CMakeLists.txt','cmake/**/*','src/**/*') }}
          restore-keys: |
            graph-${{ runner.os }}-${{ matrix.distro }}-

      # Optional: fix trust store if your runner image is missing CA certs
      - name: Ensure CA trust for git (defensive)
        shell: bash
        env:
          DISTRO: ${{ matrix.distro }}
        run: .github/scripts/ensure_ca_trust.sh
      - name: Checkout PortAudio (shallow)
        uses: actions/checkout@v4
        with:
          repository: PortAudio/portaudio
          path: external/portaudio
          fetch-depth: 1

      # Prove the path exists before CMake runs (avoids the exact error you hit)
      - name: Verify PortAudio path
        shell: bash
        env:
          DISTRO: ${{ matrix.distro }}
        run: .github/scripts/verify_portaudio_path.sh

      # Add after the PortAudio checkout
      - name: Checkout googletest (shallow)
        uses: actions/checkout@v4
        with:
          repository: google/googletest
          path: external/googletest
          fetch-depth: 1

      - name: Verify googletest path
        shell: bash
        env:
          DISTRO: ${{ matrix.distro }}
        run: .github/scripts/verify_googletest_path.sh

      - name: Audit AVS effects structure
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build
          # audit writes the full JSON report and exits non-zero on drift
          python3 tools/audit_effects.py --out build/effects_audit.json --ci

      - name: Upload effects audit artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # one artifact per matrix distro
          name: effects-audit-${{ matrix.distro }}
          path: build/effects_audit.json
          if-no-files-found: warn

      - name: Configure
        shell: bash
        env:
          DISTRO: ${{ matrix.distro }}
        run: .github/scripts/configure_build.sh
      - name: Build
        run: cmake --build build -- -k 0

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.distro }}
          include-hidden-files: true
          path: |
            build
            !build/**/*.o
            !build/**/*.a

      - name: Install
        run: cmake --install build --prefix "${PWD}/install"

  tests:
    name: Tests (${{ matrix.distro }} shard ${{ matrix.shard }} of ${{ matrix.total_shards }})
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu
            container: ubuntu:22.04
            pkg_cache: /var/cache/apt
            shard: 0
            total_shards: 2
          - distro: ubuntu
            container: ubuntu:22.04
            pkg_cache: /var/cache/apt
            shard: 1
            total_shards: 2
          - distro: fedora
            container: fedora:39
            pkg_cache: /var/cache/dnf
            shard: 0
            total_shards: 2
          - distro: fedora
            container: fedora:39
            pkg_cache: /var/cache/dnf
            shard: 1
            total_shards: 2
    container: ${{ matrix.container }}

    steps:
      - name: Detect available cores
        id: cores
        run: echo "cores=$(nproc)" >> "$GITHUB_OUTPUT"

      - name: Export parallel build level
        run: echo "CMAKE_BUILD_PARALLEL_LEVEL=${{ steps.cores.outputs.cores }}" >> "$GITHUB_ENV"

      - uses: actions/checkout@v4

      - name: Prepare cache directories
        shell: bash
        env:
          DISTRO: ${{ matrix.distro }}
        run: .github/scripts/prepare_test_directories.sh

      - name: Cache package manager artifacts
        uses: actions/cache@v4
        with:
          path: ${{ matrix.pkg_cache }}
          key: ${{ runner.os }}-${{ matrix.distro }}-pkg-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.distro }}-pkg-

      - name: Install runtime dependencies
        shell: bash
        env:
          DISTRO: ${{ matrix.distro }}
        run: .github/scripts/install_runtime_dependencies.sh

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.distro }}
          path: build-${{ matrix.distro }}

      - name: Normalize build directory
        shell: bash
        env:
          DISTRO: ${{ matrix.distro }}
        run: .github/scripts/normalize_build_directory.sh

      - name: Run tests
        shell: bash
        env:
          SHARD_INDEX: ${{ matrix.shard }}
          SHARD_TOTAL: ${{ matrix.total_shards }}
        run: .github/scripts/run_tests.sh
